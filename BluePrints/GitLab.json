{"status":{},"contains_secrets":false,"product_version":"3.0.0.0","spec":{"description":"* [GitLab UI](http:\/\/@@{GitLab.address}@@)","resources":{"client_attrs":{"None":{"y":96.5,"x":362},"6a931e0b_deployment":{"y":96.5,"x":362}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f4abb190_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"996d8a5c_runbook","main_task_local_reference":{"kind":"app_task","name":"f4abb190_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8a1f4560_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"66840d45_runbook","main_task_local_reference":{"kind":"app_task","name":"8a1f4560_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9950a5bb_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c80d8ddb_runbook","main_task_local_reference":{"kind":"app_task","name":"9950a5bb_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"1d9afbe6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"63ef680c_runbook","main_task_local_reference":{"kind":"app_task","name":"1d9afbe6_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"724e6dd1_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"057e760c_runbook","main_task_local_reference":{"kind":"app_task","name":"724e6dd1_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Disk Setup"},{"kind":"app_task","name":"GitLab Setup"}],"name":"1701d5d0_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Disk Setup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"GitLab Setup"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Disk Setup","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Generic_disk_setup_to_opt.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script is used to group all possible disk to single group and create one logical volume of that\n# Compatibility : Centos 6, 7\n##############################################\n\nsudo yum update -y --quiet\nsudo yum install -y --quiet lvm2 libudev-devel\npv_list=\"\"\t\t# This variable will store all the unused\/unclaimed disks \nfor x in {a..z}; do\n   if [ -e \/dev\/sd$x ];\t# For all providers except AWS\n   then\n      data_flag=`sudo file -sL \/dev\/sd$x | cut -d ':' -f2 | tr -d ' '`\t# It will be 'data' if disk is not claimed \/ used\n      if [ \"$data_flag\" == \"data\" ]\n      then\n      sudo pvcreate \/dev\/sd$x\n      pv_list+=\"\/dev\/sd$x \"\n      fi\n   elif [ -e \/dev\/xvd$x ];\t# AWS disks\n   then\n      data_flag=`sudo file -sL \/dev\/xvd$x | cut -d ':' -f2 | tr -d ' '`\n      if [ \"$data_flag\" == \"data\" ]\n      then\n        sudo pvcreate \/dev\/xvd$x\n        pv_list+=\"\/dev\/xvd$x \"\n      fi\n   fi\ndone\n\nif [[ ! -z $pv_list ]]; then\n\teval sudo vgcreate vg01 $pv_list # vg01 is created with all unclaimed \/ unused disks\n    sudo lvcreate -l 100%VG -n lv01 vg01\t# lv01 is created from vg01 \n\tsudo mkfs.xfs \/dev\/vg01\/lv01\n\techo -e \"\/dev\/vg01\/lv01 \\t \/opt \\t xfs \\t defaults \\t 0 0\" | sudo tee -a \/etc\/fstab # lv01 is mounted to \/opt\n\tsudo mount -a\nfi","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"GitLab Setup","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Gitlab_setup.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script to setup gitlab \n# Compatibility : Centos 6, 7\n##############################################\n\nGITLAB_DNS_NAME=\"@@{GITLAB_DNS_NAME}@@\"\n\nsudo yum install -y curl policycoreutils-python openssh-server postfix \n\nsudo systemctl start postfix\nsudo systemctl enable postfix\nsudo systemctl status postfix\n\ncurl https:\/\/packages.gitlab.com\/install\/repositories\/gitlab\/gitlab-ce\/script.rpm.sh | sudo bash\n\nsudo yum install -y gitlab-ce\nif [[ \"${GITLAB_DNS_NAME}x\" != \"x\" ]]; then \n  sudo sed -i \"s#external_url 'http:\/\/gitlab.example.com'#external_url 'http:\/\/${GITLAB_DNS_NAME}'#\" \/etc\/gitlab\/gitlab.rb\nfi\nsudo gitlab-ctl reconfigure","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"b4c3d98d_runbook","main_task_local_reference":{"kind":"app_task","name":"1701d5d0_dag"},"variable_list":[]},"name":"Common Setup"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Gitlab Uninstall"}],"name":"06aa513a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Gitlab Uninstall","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Gitlab_uninstallation.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script to remove gitlab \n# Compatibility : Centos 6, 7\n##############################################\n\nsudo yum remove -y gitlab*","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"1e125f07_runbook","main_task_local_reference":{"kind":"app_task","name":"06aa513a_dag"},"variable_list":[]},"name":"Common Uninstall"}],"depends_on_list":[],"name":"GitLab","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"AHV_ GitLab","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"editables":{"readiness_probe":{"retries":true,"delay_secs":true,"timeout_secs":null},"create_spec":{"categories":true,"name":true,"resources":{"nic_list":{"0":{"subnet_reference":true}},"serial_port_list":{},"num_vcpus_per_socket":true,"num_sockets":true,"memory_size_mib":true,"boot_config":true,"guest_customization":true,"disk_list":{"1":{"disk_size_mib":true},"3":{"disk_size_mib":true},"2":{"disk_size_mib":true}}}}},"os_type":"Linux","create_spec":{"name":"gitlab-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"cb31b81c-d69d-4ba8-9101-cb2ecf2a0bc9"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\npassword: @@{CENTOS.secret}@@\nchpasswd: { expire: False }\nssh_pwauth: True"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"9055b343-459a-4ea0-96fa-91719fcc14e8","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS_1CD","uuid":"c9bc10c2-df3f-4985-a44a-495ce5d9e110"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":10240,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":10240,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":10240,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":3,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS","editables":{"username":true,"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"GitLab"}],"name":"AHV_ GitLab_Package","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHV_ GitLab_Package"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Common Setup"}],"name":"cf645cf4_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Common Setup","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"b4c3d98d_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"9b8ae323_runbook","main_task_local_reference":{"kind":"app_task","name":"cf645cf4_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"AHV_ GitLab_Package"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Common Uninstall"}],"name":"cd4fcf4f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"GitLab"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Common Uninstall","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"1e125f07_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"53425ff7_runbook","main_task_local_reference":{"kind":"app_task","name":"cd4fcf4f_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"AHV_CENTOS_77","version":"","options":{"type":"","name":"CENTOS_77","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/download.nutanix.com\/Calm\/CentOS-7-x86_64-1908.qcow2","version":{"product_version":"","type":"","product_name":""},"architecture":"X86_64","type":""},"description":""},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"6a931e0b_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"AHV_ GitLab_Package"}],"substrate_local_reference":{"kind":"app_substrate","name":"AHV_ GitLab"},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"Nutanix","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"GITLAB_DNS_NAME","value":"gitlab.nutanix.com","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"GitLab"},"api_version":"3.0","metadata":{"last_update_time":"1592948811055535","kind":"blueprint","spec_version":4,"creation_time":"1592948373021148","categories":{"AppFamily":"DevOps"},"name":"GitLab"}}